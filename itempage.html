<!DOCTYPE html>
<!-- 앱 이름 애드몰 -->
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="itempage.css">
    <title>adimal</title>
    <link rel="icon" href="resource/favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="logo">
            <p><strong>adimal</strong></p>
            <img src="resource/logo_pur.png">
        </div>
        <div class="itemInfo">
            <div class="itemImg">
                <img src="#" alt="item image">
            </div>
            <div class="text">
                <div class="itemName">
                    <h2>정보를 불러오지 못했습니다</h2>
                </div>
                <div class="price">
                    <strong><p></p></strong>
                </div>
                <div class="sendInfo">
                    <input type="text" id ="sendInfo" placeholder="" required>
                    <p class ="errorMsg"></p>
                </div>
                <div class="buy">
                    <h4 id="buyButton">교환하기</h4> <!-- buy 버튼에 id 추가 -->
                </div>                
                <div class="avail">
                    <p>포인트 확인 불가</p>
                </div>
                <div class="desc">
                    <p></p>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemImg = document.querySelector('.itemImg img');
            const itemName = document.querySelector('.itemName h2');
            const itemPrice = document.querySelector('.price p');
            const itemDesc = document.querySelector('.desc p');
            const itemSendInfo = document.querySelector('#sendInfo'); // 수정된 부분
            const avail = document.querySelector('.avail p');
            const buyButton = document.getElementById('buyButton');
    
            // URL에서 상품 ID 가져오기
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
    
            // 상품 ID가 유효한지 체크
            if (!productId) {
                alert("상품 ID가 유효하지 않습니다.");
                return;
            }
    
            // 상품 정보 가져오기
            fetch(`https://adimal.kro.kr:3000/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) throw new Error("상품 정보를 불러오는 데 실패했습니다.");
                    return response.json();
                })
                .then(product => {
                    // 이미지 설정
                    itemImg.src = product.img || "default-image-path.png";
                    // 이름 설정
                    itemName.textContent = product.name || "Default Item Name";
                    // 가격 설정
                    const price = product.price.toLocaleString();
                    itemPrice.textContent = `${price} P`;
                    // 설명 설정
                    itemDesc.textContent = product.desc || "설명이 없습니다.";
                    // 이메일이나 아이디 설정 (추가된 부분)
                    itemSendInfo.placeholder = product.sendInfo || ""; // 수정된 부분
    
                    // 사용자 포인트 가져오기
                    const username = localStorage.getItem('username');
                    if (!username) {
                        alert("로그인이 필요합니다.");
                        return;
                    }
    
                    fetch(`https://adimal.kro.kr:3000/user/points?username=${username}`)
                        .then(response => {
                            if (!response.ok) throw new Error("포인트 정보를 불러오는 데 실패했습니다.");
                            return response.json();
                        })
                        .then(data => {
                            const userPoints = data.points;
                            if (userPoints >= product.price) {
                                avail.textContent = `교환 후 포인트: ${(Number(userPoints) - Number(product.price)).toLocaleString()} P`;
                            } else {
                                avail.textContent = "포인트 부족";
                            }
                        })
                        .catch(error => {
                            console.error(error);
                            avail.textContent = "포인트 확인 불가";
                        });
                })
                .catch(error => {
                    console.error(error);
                });
    
            // 교환하기 버튼 클릭 시 동작
            buyButton.addEventListener('click', async () => {
    // 중복 클릭 방지: 버튼 비활성화
    buyButton.disabled = true;
    buyButton.textContent = "처리 중..."; // 로딩 상태 표시

    const username = localStorage.getItem('username');
    if (!username) {
        alert("로그인이 필요합니다.");
        buyButton.disabled = false; // 실패 시 버튼 다시 활성화
        buyButton.textContent = "교환하기";
        return;
    }

    const sendInfo = document.getElementById('sendInfo').value; // 입력한 배송 정보를 가져옴
    if (!sendInfo) {
        document.getElementsByClassName('errorMsg')[0].textContent ="이 항목을 작성해 주세요"
        buyButton.disabled = false; // 실패 시 버튼 다시 활성화
        buyButton.textContent = "교환하기";
        return;
    }

    try {
        const response = await fetch(`https://adimal.kro.kr:3000/user/buyProduct`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, productId })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`구매 완료! 교환 후 포인트: ${data.points}`);

            // 거래 성공 후 거래 요청을 저장하는 요청
            await fetch('https://adimal.kro.kr:3000/user/saveTradeRequest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username,
                    productId,
                    sendInfo
                })
            });

            window.location.href = 'index.html'; // 거래 성공 후 메인 페이지로 이동
        } else {
            alert(`구매 실패: ${data.message}`);
        }
    } catch (error) {
        console.error("구매 요청 실패:", error);
        alert("구매 요청 중 문제가 발생했습니다.");
    }

    // 요청 완료 후 버튼 활성화
    buyButton.disabled = false;
    buyButton.textContent = "교환하기";
});

        });
    </script>

</body>
</html>